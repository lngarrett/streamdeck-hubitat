<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>com.ripnet.hubitat PI</title>
    <link rel="stylesheet" href="sdpi.css">
</head>
<body>
<div class="sdpi-wrapper">
    <div class="sdpi-heading">Global</div>
    <div class="sdpi-item">
        <div class="sdpi-item-label" type="field">Hostname</div>
        <input type="text" class="sdpi-item-value global" id="hostname">
    </div>
    <div class="sdpi-item">
        <div class="sdpi-item-label" type="field">Access Token</div>
        <input type="text" class="sdpi-item-value global" id="access_token">
    </div>

    <div class="sdpi-heading">Button Specific</div>
    <div class="sdpi-item">
        <div class="sdpi-item-label">Device</div>
        <select class="spdi-item-value" id="device">
            <option disabled selected>set hostname</option>
        </select>
    </div>

</div>
<script src="../resources/js/jquery-3.5.1.min.js"></script>
<script>
    let globalSettings = {};
    let localSettings = {};

    let devices = [];

    $(function() {
        $('.global').change(function() {
            let id = $(this).attr('id');
            let value = $(this).val();
            let newSettings = Object.assign({}, globalSettings);
            newSettings[id] = value;
            setGlobalSettings(newSettings);
        });

        $('#device').change(function() {
            let newSettings = Object.assign({}, localSettings);
            newSettings["device"] = $(this).val();
            // let deviceName = $('#device option:selected').text();
            // deviceName = deviceName.replace(' Switch', '');
            // deviceName = deviceName.replace(' Light', '');
            // deviceName = deviceName.replace(' Fan', '');
            // setTitle(deviceName);
            setSettings(newSettings);
        });

    });

    function globalSettingsUpdated() {
        for (const [key, value] of Object.entries(globalSettings)) {
            $('#' + key).val(value);
        }
        getDevices();
    }

    function localSettingsUpdated() {
        populateDevices();
    }
    function getDevices() {
        $.get("http://" + globalSettings.hostname + "/apps/api/229/devices/all?access_token=" + globalSettings.access_token, function(data) {
            devices = [];
            data.forEach(function(device) {
                if (device.capabilities.includes("Switch")) {
                    let d = {id: device.id, name: device.label}
                    devices.push(d);
                }
            });
            populateDevices();
        })
    }

    function populateDevices() {
        // load the devices from the array into the HTML select
        let d = $('#device');
        d.empty();
        devices.forEach(function(device) {
            d.append($("<option />").val(device.id).text(device.name));
        });
        if (localSettings.hasOwnProperty('device')) {
            $('#device option[value="'+ localSettings.device+'"]').prop('selected', true);
        }
    }

    function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo) {
        pluginUUID = inPluginUUID;

        sdWebsocket = new WebSocket("ws://127.0.0.1:" + inPort);

        function registerPlugin(inPluginUUID) {
            let json = {
                "event": inRegisterEvent,
                "uuid": inPluginUUID,
            };

            sdWebsocket.send(JSON.stringify(json));
            getGlobalSettings();
            getSettings();
        }

        sdWebsocket.onopen = function () {
            registerPlugin(pluginUUID);

        }

        sdWebsocket.onmessage = function (evt) {
            let data = JSON.parse(evt.data);
            switch (data.event) {
                case "didReceiveGlobalSettings":
                    globalSettings = data.payload['settings'];
                    globalSettingsUpdated();
                    break;
                case "didReceiveSettings":
                    localSettings = data.payload['settings'];
                    localSettingsUpdated();
                    break;
            }
        }
    }

    function getGlobalSettings() {
        let json = {
            "event": 'getGlobalSettings',
            "context": pluginUUID
        };
        sdWebsocket.send(JSON.stringify(json));
    }

    function getSettings() {
        let json = {
            "event": 'getSettings',
            "context": pluginUUID
        };
        sdWebsocket.send(JSON.stringify(json));
    }

    function updatePlugin() {
        let json = {
            "action": "com.ripnet.hubitat.update",
            "event": "sendToPlugin",
            "context": pluginUUID,
            "payload": {}
        };
        //sdWebsocket.send(JSON.stringify(json));
    }

    function setGlobalSettings(settings) {
        let json = {
            "event": "setGlobalSettings",
            "context": pluginUUID,
            "payload": settings
        };
        sdWebsocket.send(JSON.stringify(json));
        updatePlugin();
        getGlobalSettings();
    }

    function setSettings(settings) {
        let json = {
            "event": "setSettings",
            "context": pluginUUID,
            "payload": settings
        };
        sdWebsocket.send(JSON.stringify(json));
        updatePlugin();
        getSettings();
    }

    function setTitle(title) {
        let json = {
            "event": "setTitle",
            "context": pluginUUID,
            "payload": {
                "title": title,
                "target": 0
            }
        }
        console.log(json);
    }


</script>
</body>
</html>
